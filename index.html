<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المنصة التعليمية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        
        :root { /* --- Light Mode Variables --- */
            --primary-gradient-start: #8e2de2;
            --primary-gradient-end: #4a00e0;
            --secondary-color: #ff6b6b;
            --accent-color: #00b894;
            --light-text: #ffffff;
            --dark-text: #2d3436;
            --danger-red: #e74c3c;
            --success-green: #2ecc71;
            --background-color: #f9f7fe;
            --surface-color: #ffffff;
            --secondary-text-color: #636e72;
            --border-color: #e0e0e0;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.08);
            --hover-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }

        .dark-mode { /* --- Dark Mode Variables --- */
            --primary-gradient-start: #8e2de2;
            --primary-gradient-end: #4a00e0;
            --secondary-color: #ff6b6b;
            --accent-color: #00b894;
            --light-text: #f5f6fa;
            --dark-text: #f5f6fa;
            --background-color: #1e1e2e;
            --surface-color: #252542;
            --secondary-text-color: #b2bec3;
            --border-color: #3d3d5c;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.2);
            --hover-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }

        body, html {
            font-family: 'Cairo', sans-serif; 
            margin: 0; 
            padding: 0; 
            width: 100%;
            overflow-x: hidden; 
            background-color: var(--background-color); 
            color: var(--dark-text);
            transition: background-color 0.3s, color 0.3s;
        }

        .page { 
            display: none; 
            min-height: 100vh; 
            width: 100vw; 
            box-sizing: border-box; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }
        .page.active { 
            display: flex; 
        }
        .dashboard-page, #course-content-page, #student-course-view-page, #video-player-page, #student-courses-hub-page, #teacher-requests-page, #teacher-students-page { 
            justify-content: flex-start; 
        }

        .glossy-button {
            padding: 15px; 
            font-size: 1.2rem; 
            font-weight: 700; 
            border: none; 
            border-radius: 15px;
            cursor: pointer; 
            color: #ffffff; 
            background: linear-gradient(145deg, var(--primary-gradient-start), var(--primary-gradient-end));
            box-shadow: 0 5px 15px rgba(142, 45, 226, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.5);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); 
            transition: all 0.3s ease; 
            position: relative; 
            overflow: hidden;
        }
        .glossy-button:before { 
            content: ''; 
            position: absolute; 
            top: -50%; 
            left: -50%; 
            width: 20px; 
            height: 200%; 
            background: rgba(255, 255, 255, 0.4); 
            transform: rotate(45deg); 
            transition: all 0.5s ease; 
        }
        .glossy-button:hover:before { 
            left: 150%; 
        }
        .glossy-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(142, 45, 226, 0.5);
        }
        .glossy-button:active { 
            transform: translateY(1px); 
            box-shadow: 0 3px 10px rgba(142, 45, 226, 0.5); 
        }

        /* --- Modals, Headers, Navs --- */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(5px); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
            animation: fadeIn 0.3s; 
        }
        .modal-overlay.active { 
            display: flex; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        .modal-box { 
            background: var(--surface-color); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: var(--card-shadow); 
            text-align: center; 
            width: 90%; 
            max-width: 450px; 
            transform: scale(0.7); 
            animation: pop-in 0.3s forwards; 
            position: relative; 
            border: 1px solid var(--border-color);
        }
        @keyframes pop-in { 
            to { transform: scale(1); } 
        }
        .modal-box .close-btn { 
            position: absolute; 
            top: 15px; 
            left: 15px; 
            font-size: 1.5rem; 
            color: var(--secondary-text-color); 
            cursor: pointer; 
            z-index: 10; 
            transition: color 0.3s;
        }
        .modal-box .close-btn:hover {
            color: var(--secondary-color);
        }
        .modal-box form input, .modal-box form select, .modal-box form textarea { 
            text-align: right; 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 15px; 
            border: 1px solid var(--border-color); 
            border-radius: 10px; 
            box-sizing: border-box; 
            font-size: 1rem; 
            background-color: var(--background-color); 
            color: var(--dark-text); 
            transition: all 0.3s;
        }
        .modal-box form input:focus, .modal-box form select:focus, .modal-box form textarea:focus {
            border-color: var(--primary-gradient-start);
            box-shadow: 0 0 0 2px rgba(142, 45, 226, 0.2);
            outline: none;
        }
        .main-header { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 20px; 
            background-color: var(--surface-color); 
            box-shadow: 0 2px 15px rgba(0,0,0,0.1); 
            z-index: 10; 
            transition: background-color 0.3s, color 0.3s; 
            border-bottom: 1px solid var(--border-color);
        }
        .header-button { 
            color: var(--dark-text); 
            background: none; 
            border: none; 
            font-size: 1.2rem; 
            font-weight: 700; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 12px;
            border-radius: 10px;
            transition: all 0.3s;
        }
        .header-button:hover {
            background-color: rgba(142, 45, 226, 0.1);
        }
        .header-button.logout { 
            color: var(--danger-red); 
        } 
        .header-button.edit-profile { 
            color: var(--primary-gradient-start); 
        }
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            display: flex; 
            justify-content: space-around; 
            background-color: var(--surface-color); 
            box-shadow: 0 -2px 15px rgba(0,0,0,0.15); 
            padding: 12px 0; 
            border-top-right-radius: 20px; 
            border-top-left-radius: 20px; 
            z-index: 10; 
            transition: background-color 0.3s; 
            border-top: 1px solid var(--border-color);
        }
        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: var(--secondary-text-color); 
            text-decoration: none; 
            cursor: pointer; 
            padding: 5px 10px;
            border-radius: 15px;
            transition: all 0.3s;
        }
        .nav-item i { 
            font-size: 1.8rem; 
            margin-bottom: 5px; 
        } 
        .nav-item span { 
            font-size: 0.9rem; 
            font-weight: 600; 
        }
        .nav-item.active { 
            color: var(--primary-gradient-start); 
            background-color: rgba(142, 45, 226, 0.1);
        }
        .nav-item:hover {
            color: var(--primary-gradient-start);
            transform: translateY(-3px);
        }
        .content-header { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            display: flex; 
            align-items: center; 
            padding: 15px 20px; 
            background-color: var(--surface-color); 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            z-index: 10; 
            border-bottom: 1px solid var(--border-color);
        }
        .content-header .back-icon { 
            font-size: 1.2rem; 
            cursor: pointer; 
            background-color: rgba(142, 45, 226, 0.1); 
            color: var(--primary-gradient-start); 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            transition: all 0.3s; 
        }
        .content-header .back-icon:hover {
            background-color: rgba(142, 45, 226, 0.2);
            transform: scale(1.1);
        }
        .dark-mode .content-header .back-icon { 
            background-color: rgba(255,255,255,0.1); 
        }
        .content-header h1 { 
            flex-grow: 1; 
            text-align: center; 
            margin: 0; 
            font-size: 1.3rem; 
            color: var(--dark-text);
        }

        /* --- Auth & Role Selection --- */
        #role-selection-page { 
            background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url(https://images.unsplash.com/photo-1509062522246-3755977927d7?q=80&w=2132&auto=format&fit=crop) center/cover; 
            color: #ffffff; 
            text-align: center; 
        }
        .title-3d { 
            font-size: 2.5rem; 
            font-weight: 900; 
            text-shadow: 0 1px #c7c7c7, 0 2px #b6b6b6, 0 3px #a3a3a3, 0 4px 7px rgba(0,0,0,0.6); 
            margin-bottom: 10px; 
            background: linear-gradient(145deg, #ffffff, #e0e0e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .role-button { 
            width: 80%; 
            max-width: 300px; 
            margin-bottom: 15px; 
        }
        .auth-form { 
            width: 90%; 
            max-width: 400px; 
            padding: 30px; 
            background-color: var(--surface-color);
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }
        .auth-form input, .auth-form select { 
            width: 100%; 
            padding: 14px; 
            margin-bottom: 15px; 
            border: 1px solid var(--border-color); 
            border-radius: 15px; 
            box-sizing: border-box; 
            font-size: 1rem; 
            text-align: center; 
            background-color: var(--background-color); 
            color: var(--dark-text); 
            transition: all 0.3s;
        }
        .auth-form input:focus, .auth-form select:focus {
            border-color: var(--primary-gradient-start);
            box-shadow: 0 0 0 2px rgba(142, 45, 226, 0.2);
            outline: none;
        }
        .back-btn { 
            width: 100%; 
            background: #bdc3c7; 
            color: #2c3e50; 
            box-shadow: none; 
            margin-top: 10px;
        }
        .auth-tabs { 
            display: flex; 
            width: 100%; 
            margin-bottom: 20px; 
            border-radius: 50px; 
            background-color: var(--border-color); 
            padding: 5px; 
        }
        .tab { 
            flex: 1; 
            padding: 10px; 
            text-align: center; 
            border-radius: 50px; 
            cursor: pointer; 
            font-weight: 700; 
            transition: all 0.3s;
        }
        .tab.active { 
            background-color: var(--primary-gradient-start); 
            color: white; 
        }
        .auth-form-section { 
            display: none; 
            width: 100%; 
        } 
        .auth-form-section.active { 
            display: block; 
        }
        
        /* --- Teacher Dashboard & Cards --- */
        .dashboard-page { 
            padding-top: 70px; 
            padding-bottom: 80px; 
            box-sizing: border-box; 
            width: 100%;
        }
        .content-section { 
            display: none; 
            width: 100%; 
            height: 100%; 
            padding: 20px; 
            box-sizing: border-box; 
        }
        .content-section.active { 
            display: block; 
        }
        .content-section h2 { 
            text-align: center; 
            margin-bottom: 20px; 
            color: var(--dark-text);
            position: relative;
            padding-bottom: 10px;
        }
        .content-section h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 50%;
            transform: translateX(50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(to right, var(--primary-gradient-start), var(--primary-gradient-end));
            border-radius: 3px;
        }
        #courses-container, #all-courses-container, #student-courses-container, #students-container, #requests-container, #course-students-container { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }
        .course-card, .student-card, .request-card { 
            background-color: var(--surface-color); 
            border-radius: 15px; 
            padding: 20px; 
            box-shadow: var(--card-shadow); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }
        .course-card:hover, .student-card:hover, .request-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }
        .course-card-info, .student-card-info, .request-card-info { 
            flex-grow: 1; 
        }
        .course-card h3, .student-card h3, .request-card h3 { 
            margin: 0; 
            color: var(--dark-text);
        }
        .course-card p, .student-card p, .request-card p { 
            margin: 5px 0 0; 
            font-size: 0.9rem; 
            color: var(--secondary-text-color); 
        }
        .course-card .actions { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .course-card .actions button { 
            background: none; 
            border: none; 
            font-size: 1.2rem; 
            cursor: pointer; 
            padding: 8px; 
            border-radius: 10px;
            transition: all 0.3s;
        }
        .course-card .actions button:hover {
            background-color: rgba(142, 45, 226, 0.1);
            transform: scale(1.1);
        }
        .course-card .actions .content-btn { 
            color: var(--accent-color); 
        } 
        .course-card .actions .edit-btn { 
            color: var(--primary-gradient-start); 
        } 
        .course-card .actions .delete-btn { 
            color: var(--danger-red); 
        } 
        .course-card .actions .students-btn { 
            color: #9b59b6; 
        } 
        .course-card .actions .requests-btn { 
            color: #f39c12; 
            position: relative; 
        }
        .request-count-badge { 
            position: absolute; 
            top: -5px; 
            right: -8px; 
            background-color: var(--danger-red); 
            color: white; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            font-size: 0.8rem; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-weight: bold; 
        }
        #create-course-form input, #create-course-form textarea, #create-course-form select, #edit-course-form input, #edit-course-form textarea, #edit-course-form select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 10px; 
            box-sizing: border-box; 
            font-size: 1rem; 
            margin-bottom: 15px; 
            background-color: var(--background-color); 
            color: var(--dark-text); 
            transition: all 0.3s;
        }
        #create-course-form input:focus, #create-course-form textarea:focus, #create-course-form select:focus, #edit-course-form input:focus, #edit-course-form textarea:focus, #edit-course-form select:focus {
            border-color: var(--primary-gradient-start);
            box-shadow: 0 0 0 2px rgba(142, 45, 226, 0.2);
            outline: none;
        }
        .student-card .actions .delete-btn { 
            color: var(--danger-red); 
            font-size: 1.2rem; 
            background: none;
            border: none;
            cursor: pointer;
        }
        
        /* --- Course Content & Video Player --- */
        #course-content-page, #student-course-view-page, #video-player-page, #student-courses-hub-page, #teacher-requests-page, #teacher-students-page { 
            padding-top: 70px; 
            padding-bottom: 80px; 
        }
        #weeks-container, #student-weeks-container { 
            width: 95%; 
            max-width: 800px; 
            margin-top: 20px; 
        }
        .week-card { 
            background: var(--surface-color); 
            border-radius: 15px; 
            margin-bottom: 20px; 
            box-shadow: var(--card-shadow); 
            overflow: hidden; 
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }
        .week-card:hover {
            box-shadow: var(--hover-shadow);
        }
        .week-header { 
            padding: 15px; 
            font-size: 1.2rem; 
            font-weight: bold; 
            background: linear-gradient(145deg, var(--primary-gradient-start), var(--primary-gradient-end)); 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .week-header:hover {
            background: linear-gradient(145deg, var(--primary-gradient-end), var(--primary-gradient-start));
        }
        .week-content { 
            padding: 15px; 
            display: none; 
            flex-direction: column; 
            gap: 15px; 
        }
        .content-item { 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: all 0.3s;
            border-radius: 10px;
            padding: 10px;
        }
        .content-item:hover {
            background-color: rgba(142, 45, 226, 0.05);
        }
        .content-item:last-child { 
            border-bottom: none; 
        }
        .content-item-info { 
            flex-grow: 1; 
            cursor: pointer; 
        }
        .content-item-info p { 
            margin: 0; 
            font-weight: 600; 
        } 
        .content-item-info span { 
            font-size: 0.9rem; 
            color: var(--secondary-text-color); 
        }
        .content-item .actions button { 
            background: none; 
            border: none; 
            font-size: 1.1rem; 
            cursor: pointer; 
            padding: 5px; 
            color: var(--dark-text); 
            border-radius: 8px;
            transition: all 0.3s;
        }
        .content-item .actions button:hover {
            background-color: rgba(142, 45, 226, 0.1);
            transform: scale(1.1);
        }
        .dark-mode .content-item .actions button { 
            color: var(--light-text); 
        }
        .add-content-buttons { 
            display: flex; 
            justify-content: space-around; 
            padding-top: 10px; 
            border-top: 1px solid var(--border-color); 
            margin-top: 10px; 
        }
        .add-content-buttons button { 
            background: none; 
            border: 1px solid; 
            border-radius: 20px; 
            padding: 5px 10px; 
            font-weight: 600; 
            cursor: pointer; 
            color: var(--dark-text); 
            border-color: var(--dark-text); 
            transition: all 0.3s;
        }
        .add-content-buttons button:hover {
            background-color: var(--primary-gradient-start);
            color: white;
            border-color: var(--primary-gradient-start);
            transform: translateY(-2px);
        }
        #video-player-container { 
            width: 100%; 
            max-width: 900px; 
            margin: 20px auto; 
        }
        #video-player-container iframe { 
            width: 100%; 
            height: 50vh; 
            border: none; 
            border-radius: 15px; 
            box-shadow: var(--card-shadow);
        }
        
        /* --- Student Dashboard Main Page --- */
        #student-dashboard-page { 
            height: auto; 
            min-height: 100vh; 
            overflow-y: auto; 
            justify-content: flex-start; 
        }
        .dashboard-header { 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background-color: var(--surface-color); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            width: 100%; 
            box-sizing: border-box; 
            transition: background-color 0.3s; 
            border-bottom: 1px solid var(--border-color);
        }
        .slider-container { 
            width: 90vw; 
            margin: 25px auto; 
            border-radius: 20px; 
            height: 200px; 
            position: relative; 
            overflow: visible; 
            perspective: 1000px; 
            box-shadow: var(--card-shadow);
        }
        .slider-wrapper { 
            width: 100%; 
            height: 100%; 
            border-radius: 20px; 
            transform-style: preserve-3d; 
            transition: transform 0.5s ease; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2), 0 5px 10px rgba(0,0,0,0.1); 
            transform: rotateX(5deg) rotateY(-5deg); 
        }
        .slider-container:hover .slider-wrapper { 
            transform: rotateX(0) rotateY(0) scale(1.02); 
        }
        .slide { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            opacity: 0; 
            transition: opacity 0.5s; 
            border-radius: 20px; 
            overflow: hidden; 
            background-color: var(--border-color); 
        } 
        .slide.active { 
            opacity: 1; 
        } 
        .slide img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .features-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
            padding: 20px; 
            width: 100%; 
            box-sizing: border-box; 
        }
        .feature-item { 
            text-align: center; 
        } 
        .feature-item-link { 
            text-decoration: none; 
            color: inherit; 
            cursor: pointer; 
            display: block;
            transition: all 0.3s;
        } 
        .feature-item-link:hover {
            transform: translateY(-5px);
        }
        .feature-item .icon-bg { 
            width: 70px; 
            height: 70px; 
            border-radius: 20px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 2.2rem; 
            margin: 0 auto 10px; 
            transition: transform 0.3s, box-shadow 0.3s; 
            background: linear-gradient(145deg, var(--primary-gradient-start), var(--primary-gradient-end));
            color: white;
            box-shadow: var(--card-shadow); 
        } 
        .feature-item-link:hover .icon-bg { 
            transform: translateY(-5px); 
            box-shadow: var(--hover-shadow); 
        } 
        .feature-item p { 
            margin: 0; 
            font-size: 0.95rem; 
            font-weight: 600; 
            color: var(--dark-text);
        }
        .separator { 
            grid-column: 1 / -1; 
            height: 3px; 
            margin: 15px 0; 
            background: linear-gradient(90deg, #ff7474, #b3ff74, #74fff8, #7474ff, #ff74f3, #ff7474); 
            background-size: 400% 100%; 
            animation: color-flow 8s linear infinite; 
            border-radius: 3px;
        }
        @keyframes color-flow { 
            0% { background-position: 0% 50%; } 
            100% { background-position: 400% 50%; } 
        }
        .teachers-section { 
            padding: 0 20px 30px 20px; 
            width: 100%; 
            box-sizing: border-box; 
        }
        .section-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        } 
        .section-header h2 { 
            margin: 0; 
            font-size: 1.6rem; 
            color: var(--dark-text); 
            position: relative;
            padding-bottom: 8px;
        }
        .section-header h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(to right, var(--primary-gradient-start), var(--primary-gradient-end));
            border-radius: 3px;
        }
        .section-header .view-all-btn { 
            color: var(--primary-gradient-start); 
            font-weight: 700; 
            text-decoration: none; 
            font-size: 1rem; 
            cursor: pointer; 
            padding: 5px 10px;
            border-radius: 10px;
            transition: all 0.3s;
        }
        .section-header .view-all-btn:hover {
            background-color: rgba(142, 45, 226, 0.1);
        }
        .teachers-list-container { 
            display: flex; 
            overflow-x: auto; 
            gap: 15px; 
            padding-bottom: 15px; 
            -ms-overflow-style: none; 
            scrollbar-width: none; 
        }
        .teachers-list-container::-webkit-scrollbar { 
            display: none; 
        }
        .teacher-card { 
            text-align: center; 
            flex: 0 0 auto; 
            width: 90px; 
        } 
        .teacher-card img { 
            width: 90px; 
            height: 90px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 3px solid var(--primary-gradient-start); 
            transition: all 0.3s;
        } 
        .teacher-card:hover img {
            border-color: var(--primary-gradient-end);
            transform: scale(1.05);
        }
        .teacher-card p { 
            margin: 8px 0 0 0; 
            font-weight: 600; 
            font-size: 1rem; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            color: var(--dark-text); 
        }
        .subscriptions-btn { 
            padding: 8px 15px; 
            font-size: 0.9rem; 
            font-weight: bold; 
            background: var(--primary-gradient-end); 
            color: white; 
            border: none; 
            border-radius: 20px; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .subscriptions-btn:hover {
            background: var(--primary-gradient-start);
            transform: translateY(-2px);
        }

        /* --- 3D Educational Platforms Section --- */
        #platforms-section { 
            width: 100%; 
            padding: 20px 0 80px 0; 
            perspective: 1500px; 
        }
        #platforms-container { 
            display: flex; 
            flex-direction: column; 
            gap: 25px; 
            align-items: center; 
        }
        .platform-card { 
            background-color: var(--surface-color); 
            width: 90%; 
            max-width: 400px; 
            border-radius: 20px; 
            box-shadow: var(--card-shadow), inset 0 1px 1px rgba(255, 255, 255, 0.3); 
            padding: 15px; 
            transform-style: preserve-3d; 
            transform: rotateY(-8deg) rotateX(5deg); 
            transition: transform 0.5s ease; 
            border: 1px solid var(--border-color);
        }
        .platform-card:hover { 
            transform: rotateY(0) rotateX(0) scale(1.03); 
            box-shadow: var(--hover-shadow); 
        }
        .platform-teacher-info { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 12px; 
        }
        .platform-teacher-info img { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 2px solid var(--primary-gradient-end); 
            transition: all 0.3s;
        }
        .platform-teacher-info:hover img {
            border-color: var(--primary-gradient-start);
            transform: scale(1.1);
        }
        .platform-teacher-info h5 { 
            margin: 0; 
            font-size: 1.2rem; 
            color: var(--dark-text);
        }
        .platform-course-image { 
            width: 100%; 
            height: 160px; 
            border-radius: 15px; 
            overflow: hidden; 
            margin-bottom: 12px; 
        }
        .platform-course-image img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: all 0.5s;
        }
        .platform-card:hover .platform-course-image img {
            transform: scale(1.05);
        }
        .platform-card-content { 
            padding: 0 5px; 
        }
        .platform-card-content h4 { 
            margin: 0 0 5px 0; 
            font-size: 1.3rem; 
            color: var(--dark-text);
        }
        .platform-card-content .desc { 
            font-size: 0.95rem; 
            color: var(--secondary-text-color); 
            margin-bottom: 15px; 
        }
        .platform-card-pricing { 
            display: flex; 
            gap: 10px; 
            font-size: 0.9rem; 
            font-weight: bold; 
            margin-bottom: 15px; 
        }
        .price-tag { 
            background-color: var(--background-color); 
            padding: 5px 10px; 
            border-radius: 8px; 
            color: var(--primary-gradient-start);
            border: 1px solid var(--border-color);
        }
        .details-btn { 
            width: 100%; 
            padding: 12px; 
            font-size: 1.1rem; 
        }
        .enrolled-btn { 
            width: 100%; 
            padding: 12px; 
            font-size: 1.1rem; 
            background: var(--accent-color); 
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4); 
        }
        .enrolled-btn:hover {
            background: #00a885;
        }

        /* --- Modals: Course Details, Enrollment, Payment --- */
        .modal-slider { 
            height: 200px; 
            width: 100%; 
            border-radius: 15px; 
            overflow: hidden; 
            position: relative; 
            background-color: var(--border-color); 
            margin-bottom: 15px; 
            box-shadow: var(--card-shadow);
        }
        .modal-slider .slide { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            opacity: 0; 
            transition: opacity 0.5s; 
        }
        .modal-slider .slide.active { 
            opacity: 1; 
        }
        .modal-slider img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        .subscription-options { 
            margin: 20px 0; 
        }
        .subscription-options label { 
            display: block; 
            background-color: var(--background-color); 
            padding: 15px; 
            border-radius: 10px; 
            margin-bottom: 10px; 
            border: 2px solid transparent; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .subscription-options label:hover {
            background-color: rgba(142, 45, 226, 0.05);
        }
        .subscription-options input[type="radio"] { 
            display: none; 
        }
        .subscription-options input[type="radio"]:checked + label { 
            border-color: var(--primary-gradient-end); 
            background-color: rgba(142, 45, 226, 0.1); 
        }
        .subscription-options .price { 
            font-size: 1.2rem; 
            font-weight: bold; 
            color: var(--primary-gradient-end); 
        }
        #payment-proof-modal p { 
            line-height: 1.7; 
        } 
        #payment-proof-modal .payment-number { 
            font-size: 1.3rem; 
            font-weight: bold; 
            color: var(--primary-gradient-end); 
            user-select: all; 
        }
        #payment-proof-modal input[type="file"] { 
            border: 2px dashed var(--border-color); 
            padding: 20px; 
            background-color: var(--background-color); 
            border-radius: 10px;
            transition: all 0.3s;
        }
        #payment-proof-modal input[type="file"]:hover {
            border-color: var(--primary-gradient-start);
            background-color: rgba(142, 45, 226, 0.05);
        }

        /* --- Teacher Requests Page --- */
        #request-details-view { 
            display: none; 
            margin-top: 20px; 
            padding: 15px; 
            border: 1px solid var(--border-color); 
            border-radius: 10px; 
            background-color: var(--surface-color);
            box-shadow: var(--card-shadow);
        }
        #request-details-view h4 { 
            margin-top: 0; 
            color: var(--dark-text);
        }
        #request-receipt-image { 
            max-width: 100%; 
            border-radius: 10px; 
            margin-top: 10px; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        #request-receipt-image:hover {
            transform: scale(1.02);
            box-shadow: var(--hover-shadow);
        }
        #request-actions { 
            display: flex; 
            gap: 10px; 
            margin-top: 20px; 
        }
        #request-actions button { 
            flex-grow: 1; 
            padding: 12px; 
            font-size: 1.1rem; 
        }
        #request-actions .approve-btn { 
            background: var(--accent-color); 
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4); 
        }
        #request-actions .approve-btn:hover {
            background: #00a885;
        }
        #request-actions .reject-btn { 
            background: var(--danger-red); 
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4); 
        }
        #request-actions .reject-btn:hover {
            background: #c0392b;
        }

        /* --- All Teachers Page --- */
        #all-teachers-page, #teacher-students-page { 
            justify-content: flex-start; 
            padding: 20px; 
            overflow-y: auto; 
            height: auto; 
            box-sizing: border-box; 
        }
        .page-header { 
            width: 100%; 
            display: flex; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-top: 10px;
        } 
        .page-header .back-icon { 
            flex-shrink: 0; 
        } 
        .page-header h1 { 
            flex-grow: 1; 
            text-align: center; 
            margin: 0; 
            color: var(--dark-text); 
        }
        .teachers-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
            width: 100%; 
            padding-bottom: 20px; 
        }
        .teachers-grid .teacher-card { 
            width: 100%; 
        }
        .teachers-grid .teacher-card img { 
            width: 100%; 
            height: auto; 
            aspect-ratio: 1 / 1; 
        }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .features-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .teachers-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .features-grid {
                grid-template-columns: 1fr;
            }
            .teachers-grid {
                grid-template-columns: 1fr;
            }
            .content-header h1, .page-header h1 {
                font-size: 1.1rem;
            }
            .nav-item i {
                font-size: 1.5rem;
            }
            .nav-item span {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Modals -->
    <div id="custom-alert" class="modal-overlay"> <div class="modal-box"> <p id="alert-message"></p> <button id="alert-ok" class="glossy-button" style="width: 50%;">حسنًا</button> </div> </div>
    <div id="edit-course-modal" class="modal-overlay"> <div class="modal-box"> <i class="fas fa-times close-btn"></i> <h2>تعديل الكورس</h2> <form id="edit-course-form"></form> </div> </div>
    <div id="add-video-modal" class="modal-overlay"> <div class="modal-box"> <i class="fas fa-times close-btn"></i> <h2 id="video-modal-title">إضافة فيديو</h2> <form id="add-video-form"> <input type="text" id="video-title" placeholder="عنوان الفيديو" required> <input type="url" id="video-url" placeholder="رابط فيديو يوتيوب" required> <input type="text" id="video-duration" placeholder="مدة الفيديو (مثال: 15:30)" required> <button type="submit" class="glossy-button">حفظ</button> </form> </div> </div>
    <div id="add-assignment-modal" class="modal-overlay"> <div class="modal-box"> <i class="fas fa-times close-btn"></i> <h2 id="assignment-modal-title">إضافة محتوى</h2> <form id="add-assignment-form"> <input type="text" id="assignment-title" placeholder="العنوان" required> <input type="number" id="assignment-questions" placeholder="عدد الأسئلة" required> <input type="number" id="assignment-duration" placeholder="الوقت المحدد (بالدقائق)" required> <button type="submit" class="glossy-button">حفظ</button> </form> </div> </div>
    <div id="teacher-edit-modal" class="modal-overlay"> <div class="modal-box"> <i class="fas fa-times close-btn"></i> <h2>تعديل الملف الشخصي</h2> <form id="teacher-edit-form"> <input type="text" id="teacher-edit-name" placeholder="الاسم الكامل" required> <input type="tel" id="teacher-edit-phone" placeholder="رقم الهاتف" required> <input type="text" id="teacher-edit-code" placeholder="الرمز" required> <input type="url" id="teacher-edit-photo" placeholder="رابط الصورة الشخصية" required> <button type="submit" class="glossy-button">حفظ التغييرات</button> </form> </div> </div>
    <div id="student-edit-modal" class="modal-overlay"> <div class="modal-box"> <i class="fas fa-times close-btn"></i> <h2>تعديل الملف الشخصي</h2> <form id="student-edit-form"> <input type="text" id="student-edit-name" placeholder="الاسم" required> <input type="text" id="student-edit-code" placeholder="الرمز" required> <button type="submit" class="glossy-button">حفظ التغييرات</button> </form> </div> </div>
    <div id="course-details-modal" class="modal-overlay"> <div class="modal-box"> <i class="fas fa-times close-btn"></i> <div id="modal-slider-container" class="modal-slider"></div> <h2 id="modal-course-title"></h2> <p id="modal-course-description"></p> <div class="subscription-options"> <input type="radio" id="sub-monthly" name="subscription" value="monthly" checked> <label for="sub-monthly">اشتراك شهري <span id="modal-price-monthly" class="price"></span></label> <input type="radio" id="sub-term" name="subscription" value="term"> <label for="sub-term">اشتراك بالترم <span id="modal-price-term" class="price"></span></label> </div> <button id="modal-enroll-btn" class="glossy-button">اشترك الآن</button> </div> </div>
    <div id="enrollment-request-modal" class="modal-overlay"> <div class="modal-box"> <i class="fas fa-times close-btn"></i> <h2>تقديم طلب التحاق</h2> <form id="enrollment-request-form"> <input type="text" id="enroll-student-name" placeholder="اسمك الكامل" required> <input type="tel" id="enroll-student-phone" placeholder="رقم هاتفك" required> <input type="tel" id="enroll-guardian-phone" placeholder="رقم هاتف ولي الأمر" required> <input type="text" id="enroll-student-code" placeholder="الرمز الخاص بك" required> <button type="submit" class="glossy-button">التالي</button> </form> </div> </div>
    <div id="payment-proof-modal" class="modal-overlay"> <div class="modal-box"> <i class="fas fa-times close-btn"></i> <h2>إثبات الدفع</h2> <p>برجاء تحويل المبلغ <strong id="payment-amount"></strong> جنيه إلى رقم فودافون كاش التالي:</p> <p class="payment-number">01000000000</p> <p>ثم قم برفع صورة من إيصال التحويل.</p> <form id="payment-proof-form"> <input type="file" id="receipt-image-upload" accept="image/*" required> <button type="submit" class="glossy-button">إرسال الطلب</button> </form> </div> </div>

    <!-- Pages -->
    <div id="role-selection-page" class="page active"> 
        <h1 class="title-3d">المنصة التعليمية</h1> 
        <p>مرحباً بك في مستقبل التعليم الرقمي</p> 
        <button onclick="showPage('student-auth-page')" class="role-button glossy-button">
            <i class="fas fa-user-graduate" style="margin-left: 10px;"></i> أنا طالب
        </button> 
        <button onclick="showPage('teacher-auth-page')" class="role-button glossy-button">
            <i class="fas fa-chalkboard-teacher" style="margin-left: 10px;"></i> أنا معلم
        </button> 
    </div>

    <div id="student-auth-page" class="page"> 
        <div class="auth-form"> 
            <h2>تسجيل الطالب</h2> 
            <form id="student-auth-form"> 
                <input type="text" id="student-name" placeholder="الاسم" required> 
                <input type="text" id="student-code" placeholder="الرمز" required> 
                <select id="student-stage" required> 
                    <option value="" disabled selected>اختر مرحلتك الدراسية</option> 
                    <option value="prep_1">أولى إعدادي</option> 
                    <option value="prep_2">ثانية إعدادي</option> 
                    <option value="prep_3">ثالثة إعدادي</option> 
                    <option value="sec_1">أولى ثانوي</option> 
                    <option value="sec_2_sci">ثانية ثانوي - علمي</option> 
                    <option value="sec_2_lit">ثانية ثانوي - أدبي</option> 
                    <option value="sec_3_sci_science">ثالثة ثانوي - علمي علوم</option> 
                    <option value="sec_3_sci_math">ثالثة ثانوي - علمي رياضة</option> 
                    <option value="sec_3_lit">ثالثة ثانوي - أدبي</option> 
                </select> 
                <button type="submit" class="glossy-button">دخول / إنشاء حساب</button> 
            </form> 
            <button class="back-btn glossy-button" onclick="showPage('role-selection-page')">العودة</button> 
        </div> 
    </div>

    <div id="teacher-auth-page" class="page"> 
        <div class="auth-form"> 
            <div class="auth-tabs"> 
                <div class="tab active" data-form="register">إنشاء حساب</div> 
                <div class="tab" data-form="login">تسجيل الدخول</div> 
            </div> 
            <div id="teacher-register-form" class="auth-form-section active"> 
                <input type="text" id="teacher-name" placeholder="الاسم الكامل" required> 
                <input type="tel" id="teacher-phone" placeholder="رقم الهاتف" required> 
                <input type="text" id="teacher-code-reg" placeholder="الرمز" required> 
                <input type="url" id="teacher-photo" placeholder="رابط الصورة الشخصية" required> 
                <button id="teacher-register-btn" class="glossy-button">إنشاء حساب</button> 
            </div> 
            <div id="teacher-login-form" class="auth-form-section"> 
                <input type="tel" id="teacher-phone-login" placeholder="رقم الهاتف" required> 
                <input type="text" id="teacher-code-login" placeholder="الرمز" required> 
                <button id="teacher-login-btn" class="glossy-button">تسجيل الدخول</button> 
            </div> 
            <button class="back-btn glossy-button" onclick="showPage('role-selection-page')">العودة</button> 
        </div> 
    </div>
    
    <!-- Teacher Pages -->
    <div id="teacher-dashboard-page" class="page dashboard-page">
        <header class="main-header"> <h3 id="teacher-welcome-msg"></h3> <div> <button id="teacher-edit-profile-btn" class="header-button edit-profile"><i class="fas fa-edit"></i></button> <button id="teacher-logout-btn" class="header-button logout"><i class="fas fa-sign-out-alt"></i></button> </div> </header>
        <section id="your-courses-section" class="content-section active"> <h2>كورساتك</h2> <div id="courses-container"></div> </section>
        <section id="create-course-section" class="content-section"> <h2>إنشاء كورس جديد</h2> <form id="create-course-form" style="width:100%; max-width:500px; display:flex; flex-direction:column; gap:0;"> <input type="text" id="course-title" placeholder="عنوان الكورس" required> <textarea id="course-description" placeholder="وصف الكورس" required></textarea> <input type="url" id="course-main-image" placeholder="رابط الصورة الرئيسية" required> <input type="url" id="course-image-2" placeholder="رابط صورة إضافية (اختياري)"> <input type="url" id="course-image-3" placeholder="رابط صورة إضافية (اختياري)"> <input type="number" id="course-price-monthly" placeholder="سعر الاشتراك الشهري" required> <input type="number" id="course-price-term" placeholder="سعر اشتراك الترم" required> <select id="course-stage" required> <option value="" disabled selected>اختر المرحلة الدراسية</option> <option value="prep_1">أولى إعدادي</option><option value="prep_2">ثانية إعدادي</option><option value="prep_3">ثالثة إعدادي</option><option value="sec_1">أولى ثانوي</option><option value="sec_2_sci">ثانية ثانوي - علمي</option><option value="sec_2_lit">ثانية ثانوي - أدبي</option><option value="sec_3_sci_science">ثالثة ثانوي - علمي علوم</option><option value="sec_3_sci_math">ثالثة ثانوي - علمي رياضة</option><option value="sec_3_lit">ثالثة ثانوي - أدبي</option> </select> <button type="submit" class="glossy-button">نشر الكورس</button> </form> </section>
        <nav class="bottom-nav"> <a class="nav-item active" data-section="your-courses-section"><i class="fas fa-chalkboard"></i><span>كورساتك</span></a> <a class="nav-item" data-section="create-course-section"><i class="fas fa-plus-circle"></i><span>إنشاء كورس</span></a> </nav>
    </div>
    <div id="course-content-page" class="page">
        <header class="content-header"> <i class="fas fa-arrow-left back-icon" onclick="showPage('teacher-dashboard-page')"></i> <h1 id="content-course-title"></h1> <div style="width: 35px;"></div></header>
        <div id="weeks-container" style="width: 90%; max-width: 600px;"></div> <button id="add-week-btn" class="glossy-button" style="margin: 20px 0;">إضافة أسبوع جديد</button>
    </div>
    <div id="teacher-students-page" class="page">
        <header class="content-header"> <i class="fas fa-arrow-left back-icon" onclick="showPage('teacher-dashboard-page')"></i> <h1 id="students-course-title"></h1><div style="width: 35px;"></div></header>
        <div id="course-students-container" style="width: 90%; max-width: 600px; margin-top: 20px;"></div>
    </div>
    <div id="teacher-requests-page" class="page">
        <header class="content-header"> <i class="fas fa-arrow-left back-icon" onclick="showPage('teacher-dashboard-page')"></i> <h1 id="requests-course-title"></h1><div style="width: 35px;"></div></header>
        <div id="requests-container" style="width: 90%; max-width: 600px; margin-top: 20px;"></div>
        <div id="request-details-view" style="width: 90%; max-width: 600px;">
             <h4>تفاصيل الطلب</h4>
             <p><strong>الطالب:</strong> <span id="request-student-name"></span></p>
             <p><strong>الهاتف:</strong> <span id="request-student-phone"></span></p>
             <p><strong>هاتف ولي الأمر:</strong> <span id="request-guardian-phone"></span></p>
             <p><strong>الرمز:</strong> <span id="request-student-code"></span></p>
             <p><strong>صورة الإيصال:</strong></p>
             <img id="request-receipt-image" src="" alt="إيصال الدفع" style="cursor: pointer;" onclick="window.open(this.src, '_blank')">
             <div id="request-actions">
                <button class="glossy-button approve-btn" id="approve-request-btn">موافقة</button>
                <button class="glossy-button reject-btn" id="reject-request-btn">رفض</button>
             </div>
        </div>
    </div>

    <!-- Student Pages -->
    <div id="student-dashboard-page" class="page"> 
        <header class="dashboard-header"> <button id="student-edit-profile-btn" class="header-button edit-profile"><i class="fas fa-user-edit"></i></button> <h3 id="student-welcome-msg"></h3> <button id="student-logout-btn" class="header-button logout"><i class="fas fa-sign-out-alt"></i></button> </header> 
        <main style="width: 100%; overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; align-items: center;"> 
            <section class="slider-container"> <div id="slider-wrapper" class="slider-wrapper"></div> </section> 
            <section class="teachers-section"> <div class="section-header"> <h2>المعلمين</h2> <a id="view-all-teachers-btn" class="view-all-btn">الكل <i class="fas fa-arrow-left"></i></a> </div> <div id="teachers-list-container" class="teachers-list-container"></div> </section> 
            <section class="features-grid" id="features-grid"></section> 
            <section id="platforms-section">
                <div class="section-header" style="width: 90%; max-width: 400px;"> <h2>المنصات التعليمية</h2> <button class="subscriptions-btn" onclick="showCoursesHub()">اشتراكاتك</button> </div>
                <div id="platforms-container"></div>
            </section>
        </main> 
    </div>
    <div id="student-courses-hub-page" class="page">
        <header class="content-header"> <i class="fas fa-arrow-left back-icon" onclick="showPage('student-dashboard-page')"></i> <h1>كورساتي</h1><div style="width: 35px;"></div></header>
        <section id="student-courses-section" class="content-section active"> <div id="student-courses-container"></div> </section>
    </div>
    <div id="student-course-view-page" class="page">
        <header class="content-header"> <i class="fas fa-arrow-left back-icon" onclick="showCoursesHub()"></i> <h1 id="student-course-title"></h1><div style="width: 35px;"></div> </header>
        <div id="student-weeks-container"></div>
    </div>
    <div id="video-player-page" class="page">
         <header class="content-header"> <i class="fas fa-arrow-left back-icon" id="back-from-video"></i> <h1 id="video-title-header"></h1><div style="width: 35px;"></div> </header>
         <div id="video-player-container"></div>
    </div>
    <div id="all-teachers-page" class="page"> 
        <header class="page-header"> <i class="fas fa-arrow-left back-icon" onclick="showPage('student-dashboard-page')"></i> <h1>كل المعلمين</h1> <div style="flex-basis: 35px;"></div> </header> 
        <div id="all-teachers-grid" class="teachers-grid"></div> 
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        // --- Global State ---
        let currentCourseContentInfo = { courseId: null, weekKey: null, contentType: null, itemId: null, mode: 'add' };
        let currentStudentViewingCourse = null;
        let currentEnrollmentRequest = {};
        let modalSlideInterval;
        const stageMap = { prep_1: 'أولى إعدادي', prep_2: 'ثانية إعدادي', prep_3: 'ثالثة إعدادي', sec_1: 'أولى ثانوي', sec_2_sci: 'ثانية ثانوي - علمي', sec_2_lit: 'ثانية ثانوي - أدبي', sec_3_sci_science: 'ثالثة ثانوي - علمي علوم', sec_3_sci_math: 'ثالثة ثانوي - علمي رياضة', sec_3_lit: 'ثالثة ثانوي - أدبي' };

        // --- Firebase Config ---
        const firebaseConfig = { apiKey: "AIzaSyCsnZdFrg-KlWFc0z6OgmXgBp6lPKf14fU", authDomain: "saifsa-b51f1.firebaseapp.com", databaseURL: "https://saifsa-b51f1-default-rtdb.europe-west1.firebasedatabase.app", projectId: "saifsa-b51f1", storageBucket: "saifsa-b51f1.appspot.com", messagingSenderId: "41089917871", appId: "1:41089917871:web:fce49f6f23bd4f679b055a"};
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const studentsRef = database.ref('students');
        const teachersRef = database.ref('teachers');
        const coursesRef = database.ref('courses');
        const requestsRef = database.ref('subscriptionRequests');

        // --- Utility Functions ---
        function fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); }

        // --- Theme, UI & Modal Controls ---
        function applyTheme() { const currentHour = new Date().getHours(); if (currentHour >= 19 || currentHour <= 5) { document.body.classList.add('dark-mode'); } else { document.body.classList.remove('dark-mode'); } }
        function showPage(pageId) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(pageId).classList.add('active'); }
        function showModal(modalId) { document.getElementById(modalId).classList.add('active'); }
        function hideModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); clearInterval(modalSlideInterval); }
        document.querySelectorAll('.modal-overlay .close-btn').forEach(btn => btn.addEventListener('click', hideModals));
        function customAlert(message) { document.getElementById('alert-message').textContent = message; showModal('custom-alert'); }
        document.getElementById('alert-ok').addEventListener('click', hideModals);

        // --- Session Management ---
        window.addEventListener('load', () => {
            applyTheme();
            const session = JSON.parse(localStorage.getItem('userSession'));
            if (session) {
                if (session.role === 'student') {
                    updateStudentUI(session.data); loadStudentDashboardContent(session.data.stage, session.id); showPage('student-dashboard-page');
                } else if (session.role === 'teacher') {
                    updateTeacherUI(session.data); loadTeacherDashboard(session.id); showPage('teacher-dashboard-page');
                }
            } else { showPage('role-selection-page'); }
        });
        function createSession(role, data, id) { localStorage.setItem('userSession', JSON.stringify({ role, data, id })); }
        function destroySession() { localStorage.removeItem('userSession'); window.location.reload(); }
        function updateStudentUI(data) { document.getElementById('student-welcome-msg').textContent = `مرحباً ${data.name}`; }
        function updateTeacherUI(data) { document.getElementById('teacher-welcome-msg').textContent = `مرحباً يا ${data.name}`; }
        
        // --- Navigation & Tabs ---
        document.querySelectorAll('.auth-tabs .tab').forEach(tab => tab.addEventListener('click', (e) => { const formId = e.currentTarget.dataset.form; e.currentTarget.parentElement.querySelector('.active').classList.remove('active'); e.currentTarget.classList.add('active'); e.currentTarget.closest('.auth-form').querySelector('.auth-form-section.active').classList.remove('active'); document.getElementById(`teacher-${formId}-form`).classList.add('active'); }));
        document.querySelectorAll('.bottom-nav .nav-item').forEach(item => item.addEventListener('click', (e) => { const targetSectionId = e.currentTarget.dataset.section; if (targetSectionId) { e.currentTarget.parentElement.querySelector('.active').classList.remove('active'); e.currentTarget.classList.add('active'); e.currentTarget.closest('.page').querySelector('.content-section.active').classList.remove('active'); document.getElementById(targetSectionId).classList.add('active'); } }));

        // --- Student Logic ---
        document.getElementById('student-auth-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('student-name').value.trim(); const code = document.getElementById('student-code').value.trim(); const stage = document.getElementById('student-stage').value;
            if (!stage) { customAlert('الرجاء اختيار المرحلة الدراسية.'); return; }
            studentsRef.orderByChild('name').equalTo(name).once('value', snapshot => {
                if (snapshot.exists()) {
                    const studentId = Object.keys(snapshot.val())[0]; const studentData = snapshot.val()[studentId];
                    if (studentData.code === code) {
                        createSession('student', studentData, studentId);
                        updateStudentUI(studentData); loadStudentDashboardContent(studentData.stage, studentId); showPage('student-dashboard-page');
                    } else { customAlert('الرمز غير صحيح.'); }
                } else {
                    const newStudent = { name, code, stage, enrolledCourses: [] };
                    const newStudentRef = studentsRef.push(newStudent);
                    createSession('student', newStudent, newStudentRef.key);
                    updateStudentUI(newStudent); loadStudentDashboardContent(stage, newStudentRef.key); showPage('student-dashboard-page');
                }
            }).catch(err => customAlert('حدث خطأ في الاتصال بقاعدة البيانات.'));
        });
        document.getElementById('student-edit-profile-btn').addEventListener('click', () => {
            const session = JSON.parse(localStorage.getItem('userSession'));
            if (session && session.role === 'student') {
                document.getElementById('student-edit-name').value = session.data.name; document.getElementById('student-edit-code').value = session.data.code;
                showModal('student-edit-modal');
            }
        });
        document.getElementById('student-edit-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const session = JSON.parse(localStorage.getItem('userSession'));
            const updates = { name: document.getElementById('student-edit-name').value.trim(), code: document.getElementById('student-edit-code').value.trim() };
            studentsRef.child(session.id).update(updates).then(() => {
                let updatedSessionData = {...session.data, ...updates};
                createSession('student', updatedSessionData, session.id); updateStudentUI(updatedSessionData); hideModals(); customAlert('تم تحديث ملفك الشخصي بنجاح.');
            }).catch(err => customAlert('حدث خطأ: ' + err.message));
        });

        // --- Student Dashboard & Courses Hub ---
        function loadStudentDashboardContent(studentStage, studentId) { loadTeachersForStudent(); loadFeaturesGrid(); loadSlider(); loadPlatformsSection(studentStage, studentId); }
        document.getElementById('view-all-teachers-btn').addEventListener('click', (e) => { e.preventDefault(); showPage('all-teachers-page'); });
        function showCoursesHub() {
            const session = JSON.parse(localStorage.getItem('userSession'));
            if(session && session.role === 'student'){
                loadStudentCourses(session.id);
                showPage('student-courses-hub-page');
            }
        }
        function loadStudentCourses(studentId) {
            const container = document.getElementById('student-courses-container');
            studentsRef.child(studentId).child('enrolledCourses').on('value', snapshot => {
                container.innerHTML = '';
                const enrolledCourses = snapshot.val() || [];
                if (enrolledCourses.length > 0) {
                    enrolledCourses.forEach(courseId => {
                        coursesRef.child(courseId).once('value', courseSnapshot => {
                            if(courseSnapshot.exists()) {
                                const course = courseSnapshot.val();
                                teachersRef.child(course.teacherId).once('value', teacherSnapshot => {
                                    const teacherName = teacherSnapshot.val()?.name || 'غير معروف';
                                    container.innerHTML += `<div class="course-card" onclick="viewStudentCourse('${courseId}')"> <div class="course-card-info"> <h3>${course.title}</h3> <p>الأستاذ: ${teacherName}</p> </div> <i class="fas fa-chevron-left"></i></div>`;
                                });
                            }
                        });
                    });
                } else { container.innerHTML = '<p>أنت غير مشترك في أي كورس بعد. تصفح المنصات التعليمية في الصفحة الرئيسية للبدء.</p>'; }
            });
        }
        function viewStudentCourse(courseId) {
            currentStudentViewingCourse = courseId;
            const weeksContainer = document.getElementById('student-weeks-container');
            weeksContainer.innerHTML = '';
            coursesRef.child(courseId).once('value', snapshot => {
                const course = snapshot.val();
                document.getElementById('student-course-title').textContent = course.title;
                if(course.content) {
                    Object.entries(course.content).forEach(([weekKey, weekData]) => {
                         const weekNum = weekKey.split('_')[1];
                         let contentHTML = '';
                         ['videos', 'homeworks', 'exams'].forEach(type => {
                            if (weekData[type]) {
                                Object.entries(weekData[type]).forEach(([itemId, item]) => {
                                    let icon = 'fa-question-circle', itemDetails = '';
                                    if(type === 'videos') {
                                        icon = 'fa-video'; 
                                        itemDetails = item.duration;
                                    } else {
                                        icon = (type === 'homeworks') ? 'fa-pencil-alt' : 'fa-file-alt';
                                        itemDetails = ` ${item.questions} سؤال - ${item.time} دقيقة`;
                                    }
                                    contentHTML += `<div class="content-item" onclick="openContentItem('${type}', '${item.url || ''}', '${item.title}')"><div class="content-item-info"><p><i class="fas ${icon}"></i> ${item.title}</p><span>${itemDetails}</span></div></div>`;
                                });
                            }
                         });
                         const weekCard = document.createElement('div');
                         weekCard.className = 'week-card';
                         weekCard.innerHTML = `<div class="week-header"><span>الأسبوع ${weekNum}</span><i class="fas fa-chevron-down"></i></div><div class="week-content">${contentHTML || '<p>لا يوجد محتوى لهذا الأسبوع.</p>'}</div>`;
                         weeksContainer.appendChild(weekCard);
                    });
                    weeksContainer.querySelectorAll('.week-header').forEach(header => {
                        header.addEventListener('click', () => {
                            const content = header.nextElementSibling;
                            const icon = header.querySelector('i');
                            const isOpening = content.style.display !== 'flex';
                            
                            // Close all other weeks
                            weeksContainer.querySelectorAll('.week-content').forEach(c => {
                                if (c !== content) {
                                    c.style.display = 'none';
                                    c.previousElementSibling.querySelector('i').classList.remove('fa-chevron-up');
                                    c.previousElementSibling.querySelector('i').classList.add('fa-chevron-down');
                                }
                            });

                            // Toggle current week
                            content.style.display = isOpening ? 'flex' : 'none';
                            icon.classList.toggle('fa-chevron-up', isOpening);
                            icon.classList.toggle('fa-chevron-down', !isOpening);
                        });
                    });
                } else { weeksContainer.innerHTML = '<p style="text-align:center;">لم يقم المعلم بإضافة محتوى لهذا الكورس بعد.</p>'; }
                showPage('student-course-view-page');
            });
        }
        function openContentItem(type, url, title) {
            if (type === 'videos') {
                const videoId = url.split('v=')[1]?.split('&')[0] || url.split('/').pop();
                document.getElementById('video-title-header').textContent = title;
                document.getElementById('video-player-container').innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                showPage('video-player-page');
            } else { customAlert('هذه الخاصية (الواجبات/الامتحانات) قيد التطوير وستكون متاحة قريباً!'); }
        }
        document.getElementById('back-from-video').addEventListener('click', () => viewStudentCourse(currentStudentViewingCourse));

        // --- Teacher Logic ---
        document.getElementById('teacher-register-btn').addEventListener('click', () => {
             const name = document.getElementById('teacher-name').value.trim(); const phone = document.getElementById('teacher-phone').value.trim(); const code = document.getElementById('teacher-code-reg').value.trim(); const photo = document.getElementById('teacher-photo').value.trim();
            if(!name || !phone || !code || !photo) { customAlert("الرجاء ملء جميع الحقول المطلوبة."); return; }
            teachersRef.orderByChild('phone').equalTo(phone).once('value', snapshot => {
                if(snapshot.exists()) { customAlert("هذا الرقم مسجل بالفعل."); }
                else {
                    const newTeacher = { name, phone, code, photo };
                    const newTeacherRef = teachersRef.push(newTeacher);
                    createSession('teacher', newTeacher, newTeacherRef.key); updateTeacherUI(newTeacher); loadTeacherDashboard(newTeacherRef.key); showPage('teacher-dashboard-page');
                }
            });
        });
        document.getElementById('teacher-login-btn').addEventListener('click', () => {
            const phone = document.getElementById('teacher-phone-login').value.trim(); const code = document.getElementById('teacher-code-login').value.trim();
            teachersRef.orderByChild('phone').equalTo(phone).once('value', snapshot => {
                if (snapshot.exists()) {
                    const teacherId = Object.keys(snapshot.val())[0]; const teacherData = snapshot.val()[teacherId];
                    if (teacherData.code === code) {
                        createSession('teacher', teacherData, teacherId); updateTeacherUI(teacherData); loadTeacherDashboard(teacherId); showPage('teacher-dashboard-page');
                    } else { customAlert('الرمز غير صحيح.'); }
                } else { customAlert("رقم الهاتف غير مسجل."); }
            });
        });
        document.getElementById('teacher-edit-profile-btn').addEventListener('click', () => {
            const session = JSON.parse(localStorage.getItem('userSession'));
            if (session && session.role === 'teacher') {
                document.getElementById('teacher-edit-name').value = session.data.name; document.getElementById('teacher-edit-phone').value = session.data.phone; document.getElementById('teacher-edit-code').value = session.data.code; document.getElementById('teacher-edit-photo').value = session.data.photo;
                showModal('teacher-edit-modal');
            }
        });
        document.getElementById('teacher-edit-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const session = JSON.parse(localStorage.getItem('userSession'));
            const updates = { name: document.getElementById('teacher-edit-name').value.trim(), phone: document.getElementById('teacher-edit-phone').value.trim(), code: document.getElementById('teacher-edit-code').value.trim(), photo: document.getElementById('teacher-edit-photo').value.trim() };
            teachersRef.child(session.id).update(updates).then(() => {
                createSession('teacher', updates, session.id); updateTeacherUI(updates); hideModals(); customAlert('تم تحديث ملفك الشخصي بنجاح.');
            }).catch(err => customAlert('حدث خطأ: ' + err.message));
        });

        // --- Teacher Dashboard & Course Management ---
        function loadTeacherDashboard(teacherId){ loadTeacherCourses(teacherId); }
        document.getElementById('create-course-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const session = JSON.parse(localStorage.getItem('userSession'));
            if (!session || session.role !== 'teacher') { customAlert('يرجى تسجيل الدخول كمعلم أولاً.'); return; }
            const images = [document.getElementById('course-main-image').value.trim()];
            if (document.getElementById('course-image-2').value.trim()) images.push(document.getElementById('course-image-2').value.trim());
            if (document.getElementById('course-image-3').value.trim()) images.push(document.getElementById('course-image-3').value.trim());
            const courseData = { teacherId: session.id, title: document.getElementById('course-title').value.trim(), description: document.getElementById('course-description').value.trim(), images: images, priceMonthly: document.getElementById('course-price-monthly').value, priceTerm: document.getElementById('course-price-term').value, stage: document.getElementById('course-stage').value };
            coursesRef.push(courseData).then(() => { customAlert('تم نشر الكورس بنجاح!'); e.target.reset(); document.querySelector('#teacher-dashboard-page .nav-item[data-section="your-courses-section"]').click(); });
        });
        function loadTeacherCourses(teacherId) {
            const container = document.getElementById('courses-container');
            coursesRef.orderByChild('teacherId').equalTo(teacherId).on('value', snapshot => {
                container.innerHTML = snapshot.exists() ? '' : '<p>لا يوجد كورسات حالياً. قم بإنشاء كورس جديد.</p>';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const course = childSnapshot.val(); const courseId = childSnapshot.key;
                        const card = document.createElement('div');
                        card.className = 'course-card';
                        card.innerHTML = ` <div class="course-card-info"> <h3>${course.title}</h3> <p>${course.description.substring(0, 50)}...</p> </div> 
                        <div class="actions"> 
                            <button class="requests-btn" onclick="showEnrollmentRequests('${courseId}', '${course.title}')" title="طلبات الالتحاق"><i class="fas fa-user-plus"></i></button> 
                            <button class="students-btn" onclick="showCourseStudents('${courseId}', '${course.title}')" title="الطلاب"><i class="fas fa-users"></i></button> 
                            <button class="content-btn" onclick="showCourseContentPage('${courseId}', '${course.title}')" title="إدارة المحتوى"><i class="fas fa-list-alt"></i></button> 
                            <button class="edit-btn" onclick="openEditCourseModal('${courseId}')" title="تعديل الكورس"><i class="fas fa-edit"></i></button> 
                            <button class="delete-btn" onclick="deleteCourse('${courseId}')" title="حذف الكورس"><i class="fas fa-trash"></i></button> 
                        </div>`;
                        container.appendChild(card);
                        requestsRef.orderByChild('courseId').equalTo(courseId).on('value', reqSnapshot => {
                            let pendingCount = 0;
                            reqSnapshot.forEach(req => { if(req.val().status === 'pending') pendingCount++; });
                            const badge = card.querySelector('.request-count-badge');
                            if(pendingCount > 0) {
                                if(badge) { badge.textContent = pendingCount; } else { card.querySelector('.requests-btn').innerHTML += `<span class="request-count-badge">${pendingCount}</span>`; }
                            } else { if(badge) badge.remove(); }
                        });
                    });
                }
            });
        }
        function deleteCourse(courseId) { if (confirm('هل أنت متأكد من حذف هذا الكورس وكل محتواه؟')) { coursesRef.child(courseId).remove(); } }
        function openEditCourseModal(courseId) {
            showModal('edit-course-modal');
            const form = document.getElementById('edit-course-form');
            form.innerHTML = '<i>جاري تحميل البيانات...</i>';
            form.dataset.courseId = courseId;
            coursesRef.child(courseId).once('value', snapshot => {
                const course = snapshot.val();
                form.innerHTML = ` <input type="text" id="edit-course-title" value="${course.title}" required> <textarea id="edit-course-description" required>${course.description}</textarea> <input type="url" id="edit-course-main-image" value="${course.images[0] || ''}" required> <input type="url" id="edit-course-image-2" value="${course.images[1] || ''}"> <input type="url" id="edit-course-image-3" value="${course.images[2] || ''}"> <input type="number" id="edit-course-price-monthly" value="${course.priceMonthly}" required> <input type="number" id="edit-course-price-term" value="${course.priceTerm}" required> <select id="edit-course-stage" required>${document.getElementById('course-stage').innerHTML}</select> <button type="submit" class="glossy-button">حفظ التغييرات</button> `;
                document.getElementById('edit-course-stage').value = course.stage;
            });
        }
        document.getElementById('edit-course-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const courseId = e.currentTarget.dataset.courseId;
            const images = [document.getElementById('edit-course-main-image').value.trim()];
            if (document.getElementById('edit-course-image-2').value.trim()) images.push(document.getElementById('edit-course-image-2').value.trim());
            if (document.getElementById('edit-course-image-3').value.trim()) images.push(document.getElementById('edit-course-image-3').value.trim());
            const updatedData = { title: document.getElementById('edit-course-title').value.trim(), description: document.getElementById('edit-course-description').value.trim(), images: images, priceMonthly: document.getElementById('edit-course-price-monthly').value, priceTerm: document.getElementById('edit-course-price-term').value, stage: document.getElementById('edit-course-stage').value };
            coursesRef.child(courseId).update(updatedData).then(() => { hideModals(); customAlert('تم تحديث الكورس بنجاح.'); });
        });
        
        // --- Teacher: Course CONTENT Management ---
        function showCourseContentPage(courseId, courseTitle) {
            currentCourseContentInfo.courseId = courseId;
            document.getElementById('content-course-title').textContent = `محتوى: ${courseTitle}`;
            showPage('course-content-page');
            const weeksContainer = document.getElementById('weeks-container');
            coursesRef.child(courseId).child('content').on('value', snapshot => {
                weeksContainer.innerHTML = snapshot.exists() ? '' : '<p style="text-align:center;">ابدأ بإضافة أسبوع جديد.</p>';
                if (snapshot.exists()) {
                    let weekCardsHTML = '';
                    snapshot.forEach(weekSnapshot => {
                        const weekKey = weekSnapshot.key; const weekNum = weekKey.split('_')[1];
                        let contentHTML = '';
                        ['videos', 'homeworks', 'exams'].forEach(type => {
                            if (weekSnapshot.val()[type]) {
                                Object.entries(weekSnapshot.val()[type]).forEach(([itemId, item]) => {
                                    let icon = 'fa-question-circle', itemDetails = '';
                                    if(type === 'videos') {
                                        icon = 'fa-video';
                                        itemDetails = item.duration;
                                    } else {
                                        icon = (type === 'homeworks') ? 'fa-pencil-alt' : 'fa-file-alt';
                                        itemDetails = ` ${item.questions} سؤال - ${item.time} دقيقة`;
                                    }
                                    contentHTML += `<div class="content-item"><div class="content-item-info"><p><i class="fas ${icon}"></i> ${item.title}</p><span>${itemDetails}</span></div> <div class="actions"><button class="edit-btn" onclick="openEditContentModal('${weekKey}', '${type}', '${itemId}')"><i class="fas fa-edit"></i></button><button class="delete-btn" onclick="deleteContentItem('${weekKey}', '${type}', '${itemId}')"><i class="fas fa-trash"></i></button></div></div>`;
                                });
                            }
                        });
                        weekCardsHTML += ` <div class="week-card"> <div class="week-header"><span>الأسبوع ${weekNum}</span> <div class="actions"><button class="delete-btn" style="color:white; font-size: 1rem;" onclick="deleteWeek('${weekKey}')"><i class="fas fa-trash"></i></button></div></div> <div class="week-content" style="display:none;"> ${contentHTML || '<p>لا يوجد محتوى لهذا الأسبوع بعد.</p>'} <div class="add-content-buttons"> <button onclick="openAddContentModal('${weekKey}', 'videos')">+ فيديو</button> <button onclick="openAddContentModal('${weekKey}', 'homeworks')">+ واجب</button> <button onclick="openAddContentModal('${weekKey}', 'exams')">+ امتحان</button> </div> </div> </div> `;
                    });
                    weeksContainer.innerHTML = weekCardsHTML;
                    // Add event listeners for toggling week content
                    weeksContainer.querySelectorAll('.week-header').forEach(header => {
                        header.addEventListener('click', (e) => {
                            if (!e.target.closest('.delete-btn')) { // Prevent toggle when deleting
                                header.nextElementSibling.style.display = header.nextElementSibling.style.display === 'flex' ? 'none' : 'flex';
                            }
                        });
                    });
                }
            });
        }
        document.getElementById('add-week-btn').addEventListener('click', () => {
            const contentRef = coursesRef.child(currentCourseContentInfo.courseId).child('content');
            contentRef.once('value', snapshot => {
                let nextWeekNum = 1;
                if (snapshot.exists()) {
                    const weekKeys = Object.keys(snapshot.val());
                    const weekNumbers = weekKeys.map(key => parseInt(key.split('_')[1])).filter(num => !isNaN(num));
                    if (weekNumbers.length > 0) {
                        nextWeekNum = Math.max(...weekNumbers) + 1;
                    }
                }
                contentRef.child(`week_${nextWeekNum}`).set({ createdAt: firebase.database.ServerValue.TIMESTAMP });
            });
        });
        function deleteWeek(weekKey) { if(confirm('هل أنت متأكد من حذف هذا الأسبوع وكل محتواه؟')) { coursesRef.child(currentCourseContentInfo.courseId).child('content').child(weekKey).remove(); } }
        function deleteContentItem(weekKey, contentType, itemId) { if(confirm('هل أنت متأكد من حذف هذا العنصر؟')) { coursesRef.child(currentCourseContentInfo.courseId).child('content').child(weekKey).child(contentType).child(itemId).remove(); } }
        function openAddContentModal(weekKey, contentType) {
            currentCourseContentInfo = { ...currentCourseContentInfo, weekKey, contentType, mode: 'add' };
            if (contentType === 'videos') { document.getElementById('video-modal-title').textContent = 'إضافة فيديو جديد'; document.getElementById('add-video-form').reset(); showModal('add-video-modal'); } 
            else { document.getElementById('assignment-modal-title').textContent = contentType === 'homeworks' ? 'إضافة واجب جديد' : 'إضافة امتحان جديد'; document.getElementById('add-assignment-form').reset(); showModal('add-assignment-modal'); }
        }
        function openEditContentModal(weekKey, contentType, itemId) {
            currentCourseContentInfo = { ...currentCourseContentInfo, weekKey, contentType, itemId, mode: 'edit' };
            const itemRef = coursesRef.child(currentCourseContentInfo.courseId).child('content').child(weekKey).child(contentType).child(itemId);
            itemRef.once('value', snapshot => {
                const item = snapshot.val();
                if (contentType === 'videos') {
                    document.getElementById('video-modal-title').textContent = 'تعديل الفيديو'; document.getElementById('video-title').value = item.title; document.getElementById('video-url').value = item.url; document.getElementById('video-duration').value = item.duration;
                    showModal('add-video-modal');
                } else {
                    document.getElementById('assignment-modal-title').textContent = 'تعديل ' + (contentType === 'homeworks' ? 'الواجب' : 'الامتحان');
                    document.getElementById('assignment-title').value = item.title; document.getElementById('assignment-duration').value = item.time; document.getElementById('assignment-questions').value = item.questions;
                    showModal('add-assignment-modal');
                }
            });
        }
        document.getElementById('add-video-form').addEventListener('submit', e => { e.preventDefault(); const { courseId, weekKey, contentType, itemId, mode } = currentCourseContentInfo; const videoData = { title: document.getElementById('video-title').value, url: document.getElementById('video-url').value, duration: document.getElementById('video-duration').value }; const ref = coursesRef.child(courseId).child('content').child(weekKey).child(contentType); const promise = (mode === 'add') ? ref.push(videoData) : ref.child(itemId).update(videoData); promise.then(() => { hideModals(); e.target.reset(); }); });
        document.getElementById('add-assignment-form').addEventListener('submit', e => { e.preventDefault(); const { courseId, weekKey, contentType, itemId, mode } = currentCourseContentInfo; const assignmentData = { title: document.getElementById('assignment-title').value, time: document.getElementById('assignment-duration').value, questions: document.getElementById('assignment-questions').value }; const ref = coursesRef.child(courseId).child('content').child(weekKey).child(contentType); const promise = (mode === 'add') ? ref.push(assignmentData) : ref.child(itemId).update(assignmentData); promise.then(() => { hideModals(); e.target.reset(); }); });

        // --- Student Dashboard Content ---
        document.getElementById('teacher-logout-btn').addEventListener('click', destroySession);
        document.getElementById('student-logout-btn').addEventListener('click', destroySession);
        function loadTeachersForStudent() {
            const listContainer = document.getElementById('teachers-list-container'); const gridContainer = document.getElementById('all-teachers-grid');
            listContainer.innerHTML = ''; gridContainer.innerHTML = '';
            teachersRef.once('value', snapshot => {
                if (!snapshot.exists()) { const noTeachersMsg = '<p>لا يوجد معلمين حالياً</p>'; listContainer.innerHTML = noTeachersMsg; gridContainer.innerHTML = noTeachersMsg; return; }
                snapshot.forEach(childSnapshot => {
                    const teacher = childSnapshot.val(); const placeholderImg = 'https://via.placeholder.com/80/0984e3/FFFFFF?text=T';
                    const teacherCardHTML = `<div class="teacher-card"><img src="${teacher.photo || placeholderImg}" alt="${teacher.name}" onerror="this.src='${placeholderImg}'"><p>${teacher.name}</p></div>`;
                    listContainer.innerHTML += teacherCardHTML; gridContainer.innerHTML += teacherCardHTML;
                });
            });
        }
        function loadSlider() {
            const sliderWrapper = document.getElementById('slider-wrapper'); const adsRef = database.ref('ads'); let slideInterval;
            adsRef.on('value', (snapshot) => {
                clearInterval(slideInterval); const adsData = snapshot.val(); if (!adsData) { sliderWrapper.innerHTML = ''; return; }
                const slidesData = Object.values(adsData); if (slidesData.length === 0) return;
                sliderWrapper.innerHTML = '';
                slidesData.forEach((ad, index) => {
                    const slideElement = document.createElement('div'); slideElement.className = 'slide' + (index === 0 ? ' active' : '');
                    const imageElement = document.createElement('img'); imageElement.src = ad.imageUrl;
                    slideElement.appendChild(ad.linkUrl ? Object.assign(document.createElement('a'), {href: ad.linkUrl, innerHTML: imageElement.outerHTML}) : imageElement);
                    sliderWrapper.appendChild(slideElement);
                });
                if (slidesData.length > 1) { let currentIndex = 0; slideInterval = setInterval(() => { const slides = sliderWrapper.querySelectorAll('.slide'); slides[currentIndex].classList.remove('active'); currentIndex = (currentIndex + 1) % slides.length; slides[currentIndex].classList.add('active'); }, 4000); }
            });
        }
        function loadFeaturesGrid() {
            const featuresContainer = document.getElementById('features-grid');
            featuresContainer.innerHTML = `
                <div class="feature-item" data-key="my_courses"><a class="feature-item-link" onclick="showCoursesHub()"><div class="icon-bg"><i class="fas fa-book-open"></i></div><p>كورساتي</p></a></div>
                <div class="feature-item" data-key="programming"><a class="feature-item-link"><div class="icon-bg"><i class="fa-solid fa-code"></i></div><p>منصة البرمجة</p></a></div>
                <div class="feature-item" data-key="safeAI"><a class="feature-item-link"><div class="icon-bg"><i class="fa-solid fa-shield-halved"></i></div><p>Safe AI</p></a></div>
                <div class="separator"></div>
                <div class="feature-item" data-key="xo_game"><a class="feature-item-link"><div class="icon-bg"><i class="fa-solid fa-gamepad"></i></div><p>لعبة XO</p></a></div>
                <div class="feature-item" data-key="cola_game"><a class="feature-item-link"><div class="icon-bg"><i class="fa-solid fa-puzzle-piece"></i></div><p>لعبة حبال الكولا</p></a></div>
                <div class="feature-item" data-key="exams_homework"><a class="feature-item-link" onclick="showCoursesHub()"><div class="icon-bg"><i class="fa-solid fa-file-pen"></i></div><p>الاختبارات</p></a></div>
                <div class="separator"></div>
                <div class="feature-item" data-key="chat"><a class="feature-item-link"><div class="icon-bg"><i class="fa-solid fa-comments"></i></div><p>الدردشة</p></a></div>
                <div class="feature-item" data-key="kerio"><a class="feature-item-link"><div class="icon-bg"><i class="fa-solid fa-laptop-file"></i></div><p>حل منصة كيريو</p></a></div>
                <div class="feature-item" data-key="shorts"><a class="feature-item-link"><div class="icon-bg"><i class="fa-solid fa-photo-film"></i></div><p>الشورتس</p></a></div>
            `;
            const categoriesRef = database.ref('categories');
            categoriesRef.on('value', (snapshot) => {
                const links = snapshot.val(); if (!links) return;
                featuresContainer.querySelectorAll('.feature-item-link').forEach(link => {
                    const key = link.parentElement.dataset.key;
                    if(links[key] && !['my_courses', 'exams_homework'].includes(key)) link.href = links[key];
                });
            });
        }

        // --- Platforms & Enrollment Logic ---
        async function loadPlatformsSection(studentStage, studentId) {
            const container = document.getElementById('platforms-container');
            const studentSnapshot = await studentsRef.child(studentId).once('value');
            const studentData = studentSnapshot.val();
            const enrolledCourses = studentData.enrolledCourses || [];

            coursesRef.orderByChild('stage').equalTo(studentStage).on('value', snapshot => {
                container.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const course = childSnapshot.val(); const courseId = childSnapshot.key;
                        teachersRef.child(course.teacherId).once('value', teacherSnapshot => {
                            const teacher = teacherSnapshot.val();
                            if(teacher){
                                const isEnrolled = enrolledCourses.includes(courseId);
                                const buttonHTML = isEnrolled 
                                ? `<button class="glossy-button enrolled-btn" onclick="viewStudentCourse('${courseId}')">أنت مشترك - فتح</button>`
                                : `<button class="glossy-button details-btn" onclick="openCourseDetailsModal('${courseId}')">تفاصيل</button>`;
                                const cardHTML = `
                                <div class="platform-card">
                                    <div class="platform-teacher-info"> <img src="${teacher.photo || 'https://via.placeholder.com/40'}" alt="${teacher.name}"> <h5>${teacher.name}</h5> </div>
                                    <div class="platform-course-image"> <img src="${course.images[0] || 'https://via.placeholder.com/400x160'}" alt="${course.title}"> </div>
                                    <div class="platform-card-content"> <h4>${course.title}</h4> <p class="desc">${course.description.substring(0, 60)}...</p>
                                        <div class="platform-card-pricing"> <span class="price-tag">ترم: ${course.priceTerm} ج.م</span> <span class="price-tag">شهري: ${course.priceMonthly} ج.م</span> </div>
                                        ${buttonHTML}
                                    </div>
                                </div>`;
                                container.innerHTML += cardHTML;
                            }
                        });
                    });
                } else { container.innerHTML = '<p>لا توجد منصات تعليمية متاحة لمرحلتك الدراسية حالياً.</p>'; }
            });
        }
        function openCourseDetailsModal(courseId) {
            coursesRef.child(courseId).once('value', snapshot => {
                const course = snapshot.val(); if (!course) return;
                document.getElementById('modal-course-title').textContent = course.title;
                document.getElementById('modal-course-description').textContent = course.description;
                document.getElementById('modal-price-monthly').textContent = `${course.priceMonthly} ج.م`;
                document.getElementById('modal-price-term').textContent = `${course.priceTerm} ج.م`;
                const sliderContainer = document.getElementById('modal-slider-container'); sliderContainer.innerHTML = ''; clearInterval(modalSlideInterval);
                if (course.images && course.images.length > 0) {
                    course.images.forEach((imgUrl, index) => { sliderContainer.innerHTML += `<div class="slide ${index === 0 ? 'active' : ''}"><img src="${imgUrl}" alt="صورة الكورس"></div>`; });
                    if(course.images.length > 1) { let currentIndex = 0; modalSlideInterval = setInterval(() => { const slides = sliderContainer.querySelectorAll('.slide'); slides[currentIndex].classList.remove('active'); currentIndex = (currentIndex + 1) % slides.length; slides[currentIndex].classList.add('active'); }, 3000); }
                }
                document.getElementById('modal-enroll-btn').onclick = () => openEnrollmentRequestModal(courseId, course.teacherId, course);
                showModal('course-details-modal');
            });
        }
        function openEnrollmentRequestModal(courseId, teacherId, courseData){
            const session = JSON.parse(localStorage.getItem('userSession'));
            if(!session || session.role !== 'student') { customAlert('يرجى تسجيل الدخول كطالب أولا.'); return; }
            hideModals(); 
            currentEnrollmentRequest = { courseId, teacherId, courseData };
            document.getElementById('enroll-student-name').value = session.data.name; document.getElementById('enroll-student-code').value = session.data.code;
            document.getElementById('enroll-student-phone').value = ''; document.getElementById('enroll-guardian-phone').value = '';
            showModal('enrollment-request-modal');
        }
        document.getElementById('enrollment-request-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const session = JSON.parse(localStorage.getItem('userSession'));
            currentEnrollmentRequest.studentId = session.id;
            currentEnrollmentRequest.studentName = document.getElementById('enroll-student-name').value;
            currentEnrollmentRequest.studentPhone = document.getElementById('enroll-student-phone').value;
            currentEnrollmentRequest.guardianPhone = document.getElementById('enroll-guardian-phone').value;
            currentEnrollmentRequest.studentCode = document.getElementById('enroll-student-code').value;
            const selectedSub = document.querySelector('#course-details-modal input[name="subscription"]:checked').value;
            const amount = selectedSub === 'monthly' ? currentEnrollmentRequest.courseData.priceMonthly : currentEnrollmentRequest.courseData.priceTerm;
            document.getElementById('payment-amount').textContent = amount;
            hideModals();
            showModal('payment-proof-modal');
        });
        document.getElementById('payment-proof-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const imageFile = document.getElementById('receipt-image-upload').files[0];
            if(!imageFile) { customAlert("يرجى اختيار صورة الإيصال."); return; }
            try {
                const receiptImageBase64 = await fileToBase64(imageFile);
                const requestData = { ...currentEnrollmentRequest, receiptImage: receiptImageBase64, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP };
                delete requestData.courseData; 
                await requestsRef.push(requestData);
                hideModals(); customAlert('تم إرسال طلبك بنجاح وفي انتظار موافقة المعلم.'); e.target.reset();
            } catch (error) { customAlert('حدث خطأ أثناء رفع الصورة. يرجى المحاولة مرة أخرى.'); }
        });
        
        // --- Teacher Requests & Student Management Logic ---
        function showEnrollmentRequests(courseId, courseTitle) {
            document.getElementById('requests-course-title').textContent = `طلبات: ${courseTitle}`;
            const container = document.getElementById('requests-container');
            const detailsView = document.getElementById('request-details-view');
            detailsView.style.display = 'none';
            requestsRef.orderByChild('courseId').equalTo(courseId).on('value', snapshot => {
                container.innerHTML = '';
                let hasPendingRequests = false;
                snapshot.forEach(childSnapshot => {
                    const request = childSnapshot.val();
                    if(request.status === 'pending') {
                        hasPendingRequests = true;
                        container.innerHTML += `<div class="request-card" onclick="showRequestDetails('${childSnapshot.key}')"> <div class="request-card-info"> <h3>${request.studentName}</h3> </div> <i class="fas fa-chevron-left"></i> </div>`;
                    }
                });
                if(!hasPendingRequests) { container.innerHTML = '<p>لا توجد طلبات التحاق جديدة لهذا الكورس.</p>'; }
            });
            showPage('teacher-requests-page');
        }
        function showRequestDetails(requestId) {
            requestsRef.child(requestId).once('value', snapshot => {
                const request = snapshot.val();
                document.getElementById('request-student-name').textContent = request.studentName;
                document.getElementById('request-student-phone').textContent = request.studentPhone;
                document.getElementById('request-guardian-phone').textContent = request.guardianPhone;
                document.getElementById('request-student-code').textContent = request.studentCode;
                document.getElementById('request-receipt-image').src = request.receiptImage;
                document.getElementById('approve-request-btn').onclick = () => approveRequest(requestId, request.studentId, request.courseId);
                document.getElementById('reject-request-btn').onclick = () => rejectRequest(requestId);
                document.getElementById('request-details-view').style.display = 'block';
            });
        }
        async function approveRequest(requestId, studentId, courseId) {
            try {
                const studentCoursesRef = studentsRef.child(studentId).child('enrolledCourses');
                const snapshot = await studentCoursesRef.once('value');
                const enrolledCourses = snapshot.val() || [];
                if (!enrolledCourses.includes(courseId)) { enrolledCourses.push(courseId); await studentCoursesRef.set(enrolledCourses); }
                await requestsRef.child(requestId).update({ status: 'approved' });
                customAlert('تمت الموافقة على الطالب بنجاح.'); document.getElementById('request-details-view').style.display = 'none';
            } catch(e) { customAlert('حدث خطأ. لم يتم قبول الطالب.'); }
        }
        async function rejectRequest(requestId) {
            await requestsRef.child(requestId).update({ status: 'rejected' });
            customAlert('تم رفض الطلب.'); document.getElementById('request-details-view').style.display = 'none';
        }
        async function showCourseStudents(courseId, courseTitle) {
            document.getElementById('students-course-title').textContent = `طلاب كورس: ${courseTitle}`;
            const container = document.getElementById('course-students-container');
            container.innerHTML = '<p>جاري تحميل الطلاب...</p>';
            
            const allStudentsSnapshot = await studentsRef.once('value');
            let enrolledStudentsHTML = '';
            if (allStudentsSnapshot.exists()) {
                allStudentsSnapshot.forEach(studentSnapshot => {
                    const student = studentSnapshot.val();
                    const studentId = studentSnapshot.key;
                    if (student.enrolledCourses && student.enrolledCourses.includes(courseId)) {
                        enrolledStudentsHTML += `<div class="student-card"> <div class="student-card-info"> <h3>${student.name}</h3> <p>المرحلة: ${stageMap[student.stage] || 'غير محدد'}</p> </div> <div class="actions"><button class="delete-btn" onclick="removeStudentFromCourse('${studentId}', '${courseId}')"><i class="fas fa-user-slash"></i></button></div></div>`;
                    }
                });
            }
            container.innerHTML = enrolledStudentsHTML || '<p>لا يوجد طلاب مشتركين في هذا الكورس حالياً.</p>';
            showPage('teacher-students-page');
        }
        async function removeStudentFromCourse(studentId, courseId) {
            if(confirm('هل أنت متأكد من حذف هذا الطالب من الكورس؟ سيتم إلغاء اشتراكه.')) {
                try {
                    const studentCoursesRef = studentsRef.child(studentId).child('enrolledCourses');
                    const snapshot = await studentCoursesRef.once('value');
                    let enrolledCourses = snapshot.val() || [];
                    enrolledCourses = enrolledCourses.filter(id => id !== courseId);
                    await studentCoursesRef.set(enrolledCourses);
                    customAlert('تم حذف الطالب من الكورس بنجاح.');
                    const courseTitle = document.getElementById('students-course-title').textContent.replace('طلاب كورس: ', '');
                    showCourseStudents(courseId, courseTitle);
                } catch(e) { customAlert('حدث خطأ أثناء حذف الطالب.'); }
            }
        }

    </script>
</body>
</html>
